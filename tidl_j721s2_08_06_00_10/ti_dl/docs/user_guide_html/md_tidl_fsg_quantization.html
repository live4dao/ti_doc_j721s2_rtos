<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<title>TI Deep Learning Product User Guide: TIDL-RT: Quantization</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ti_logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">TI Deep Learning Product User Guide
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md_tidl_fsg_quantization.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">TIDL-RT: Quantization </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#did_tidl_quantization_intro">Introduction</a><ul><li class="level2"><a href="#did_tidl_quantization_Layers">TIDL Layers which Requires Parameter Quantization</a></li>
</ul>
</li>
<li class="level1"><a href="#did_tidl_quantization_Types">Quantization Options</a><ul><li class="level2"><a href="#did_tidl_quantization_1">A. Post Training Quantization (PTQ)</a></li>
<li class="level2"><a href="#did_tidl_quantization_2">B. Guidelines For Training To Get Best Accuracy With Quantization</a></li>
<li class="level2"><a href="#did_tidl_quantization_3">C. Quantization Aware Training (QAT)</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="did_tidl_quantization_intro"></a>
Introduction</h1>
<ul>
<li>A DNN inference engine using Floating point operations suffer power and cost efficiency. These floating point operations can be substituted with fixed point operations (8 or 16 bit) without losing much inference accuracy.</li>
<li>TIDL-RT provides state-of-art Post Training Quantization (PTQ) and calibration algorithms as explained <a href="md_tidl_overview.html">here</a> (refer Best Accuracy section).</li>
<li>TIDL-RT supports 8-bit, 16-bit and mixed precision inference. It is recommended to use 8-bit inference mode for best execution time and use mixed-precision and/or 16-bit if you observe any accuracy gap with 8-bit inference</li>
</ul>
<p>In TIDL, the scales for parameters and activations are selected separately based on their range (Minimum and Maximum values). The scales are passed through layer processing from producer layer to consumer layer till the last layer. All the activations and parameters are maintained in fixed point representation and have a floating point scale associated with them. At the end user can convert final output tensors to floating point by dividing each element in the tensors by their corresponding floating point scale.</p>
<div class="image">
<img src="TIDL_Quant_Intro1.png" alt="TIDL_Quant_Intro1.png"/>
<div class="caption">
TIDL - Basic Quantization</div></div>
<p> There are multiple schemes to select the scale for a given tensor based on the expected range. The image below shows two schemes for selecting the scale for a signed tensor:</p>
<div class="image">
<img src="TIDL_Quant_Intro2.png" alt="TIDL_Quant_Intro2.png"/>
<div class="caption">
TIDL - Scale Selection Schemes</div></div>
<p> If the tensor data is unsigned (for example output of ReLU layer), then the entire range can be used for representing positive range only. This would help in achieving lesser quantization error.</p>
<div class="image">
<img src="TIDL_Quant_Intro3.png" alt="TIDL_Quant_Intro3.png"/>
<div class="caption">
TIDL - Scale Selection Schemes</div></div>
<p> TIDL SW supports:</p><ul>
<li>Both Power of two scales (TIDL_QuantStyleP2Dynamic) and Non-power two scales (TIDL_QuantStyleNP2Fixed) for Parameters/Weights. User can configure one of them.</li>
<li>Power of two scales for Activation/Feature maps.</li>
</ul>
<h2><a class="anchor" id="did_tidl_quantization_Layers"></a>
TIDL Layers which Requires Parameter Quantization</h2>
<ul>
<li>Convolution Layer</li>
<li>De-convolution Layer</li>
<li>Inner-Product Layer</li>
<li>Batch Normalization (Scale/Mul, Bias/Add, PReLU)</li>
</ul>
<h1><a class="anchor" id="did_tidl_quantization_Types"></a>
Quantization Options</h1>
<p>TIDL provides the following quantization options to the user:</p><ul>
<li>A. Post Training Quantization (PTQ)</li>
<li>B. Guidelines For Training To Get Best Accuracy With Quantization</li>
<li>C. Quantization Aware Training (QAT)</li>
</ul>
<p>We recommend to use option 'A' for the network first, if the quantization accuracy loss is not acceptable, then you can try option 'B'. If the result with 'B' is also not acceptable, then the user can use option 'C'. This solution shall work most of the time. The only drawback of this solution is that it would need additional effort from the user to re-train the network.</p>
<div class="image">
<img src="TIDL_Quant_Options.png" alt="TIDL_Quant_Options.png"/>
<div class="caption">
TIDL - Quantization Options </div></div>
 <h2><a class="anchor" id="did_tidl_quantization_1"></a>
A. Post Training Quantization (PTQ)</h2>
<ul>
<li>Training free Quantization – Most preferred option</li>
<li>PTQ has the following options available:<ul>
<li>Simple Calibration</li>
<li>Advanced Calibration</li>
<li>Per-channel Weight Quantization for Depthwise Convolution Layers</li>
<li>Mixed Precision</li>
<li>Future/Planned Improvements</li>
</ul>
</li>
</ul>
<h3>A.1. Simple Calibration</h3>
<ul>
<li>This option is the default option of TIDL-RT<ul>
<li>Supports Power of 2 and Non Power of 2 scales for parameters</li>
<li>Supports only power of 2 scales for feature maps</li>
<li>Scale selected based on min and max values in the given layer</li>
<li>Range for each feature maps are calibrated offline with few sample inputs</li>
<li>Calibrated range (Min and Mix) Values are used for Quantizing feature maps in target during inference (real time)</li>
<li>Observed accuracy drop less than 1% w.r.t floating point for many networks with 8-bits<ul>
<li>For example models such as Resnets, SqueezeNet, VGG, etc ( especially models which don't use Depthwise convolution layers)</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3>A.2. Advanced Calibration</h3>
<ul>
<li>This feature should be used if 8 bit accuracy is not in acceptable range with simple calibration as described above. There are multiple options which are available for this and user can incrementally try these options to see if accuracy is in acceptable range. Following are the various options available:</li>
</ul>
<h4>A.2.1. Histogram based activation range collection:</h4>
<ul>
<li>To enable this feature user needs to set calibrationOption to 1 in the TIDL-RT import config file. Typically no other parameter is required to be set as default parameters works for most of the cases.</li>
<li>This feature uses the histogram of feature map activation ranges to remove outliers which can affect the overall range. This helps in reducing the accuracy loss due to quantization.</li>
<li>User can also experiment with following parameters related to this option if required:<ul>
<li>percentileActRangeShrink: This parameter is the percentile of the total number of elements in an activation tensor which need to be discarded from both sides of the activation's statistical distribution. If input is unsigned then this is applied to only one side of the activation's statistical distribution. For example percentileRangeShrink = 0.01, means to discard 1/10000 elements from one or both sides of the activation's statistical distribution.</li>
</ul>
</li>
</ul>
<h4>A.2.2. Advanced Bias calibration:</h4>
<ul>
<li>To enable this feature user needs to only set calibrationOption to 7 in TIDL-RT import config file. Typically no other parameter is required to be set as default parameters works for most of the cases. It is observed that using 50 or more number of images gives considerable accuracy boost.</li>
<li>This feature applies a clipping to the weights and update the bias to compensate the DC errors introduced because of quantization. To understand details of this feature please refer the following <a href="https://github.com/TexasInstruments/edgeai-torchvision/blob/master/docs/pixel2pixel/Calibration.md">Link</a></li>
<li>User can also experiment with following parameters related to this option if required:<ul>
<li>biasCalibrationFactor: Each iteration the difference between the per-channel floating point mean and quantized mean output of activation range is used to update the bias. This parameter is used to indicate the contribution of this difference which should be used to update the bias. User can always use the default value</li>
<li>biasCalibrationIterations: Number of iteration to be used for bias calibration.</li>
<li>numFramesBiasCalibration: Number of input frames to be used for bias calibration</li>
</ul>
</li>
</ul>
<h4>A.3. Per-channel Weight Quantization for Depthwise Convolution Layers:</h4>
<ul>
<li>To enable this feature user needs to set calibrationOption to 13 in import config file. Typically no other parameter is required to be set as default parameters works for most of the cases.</li>
<li>This feature enables per-channel quantization for weights for depthwise separable convolution layers in the network. Currently this feature is only supported with power of 2 quantization scheme i.e. quantizationStyle = 3. Even if user sets it to anything else internally this will be converted to power of 2.</li>
</ul>
<h4>A.4. Mixed Precision :</h4>
<ul>
<li>This feature allows user to run only certain layers in higher precision ( i.e. in 16 bit) whereas rest of the network runs in 8 bit. As the precision keeps changing throughout the network this feature is called as Mixed Precision.</li>
<li>User can use this feature using following ways :<ul>
<li>By setting calibrationOption for some pre-defined configurations. Following are the details of these configuration options :<ul>
<li>Mixed precision for all depthwise convolution layers ( calibrationOption = 16) : When this option is enabled all the depthwise convolution layers weights will be quantized to 16 bits.</li>
<li>First layer processing in 16 bit ( calibrationOption = 32) : When this option is enabled the first layer's weight of the network will be quantized to 16 bits.</li>
<li>If user is already using some calibrationOption then they can do a bit wise "OR" with the above two options and provide during import.</li>
</ul>
</li>
<li>Manually selecting layers for mixed precision :<ul>
<li>User can manually specify the layers which they want to run in higher precision ( i.e. in 16 bits) using outputFeature16bitNamesList and params16bitNamesList parameters of import configuration. Please refer <a href="md_tidl_model_import.html#tidl_model_import_2"><b>here</b></a> to understand the details of these parameters. User has option to either increase only parameters/weights precision to 16 bit or to have both activation and parameters of a particular layer in 16 bit.</li>
<li>TIDL allows change of precision for certain set of layers ( mentioned below ). For layers not mentioned in this list, you cannot change the precision. This means that the layers which support change in precision can have input, output and parameters in different precision. Whereas the layers which do not support change in precision will always have input, output and parameters in same precision. The impact of this is that for a particular layer which doesn't support change in precision, the input, output and parameter's precision will be automatically determined based on the producer or consumer of the layer. For example, for the concat layer, which doesn't support change in precision, if the output is in 16 bit because of its consumer layer or because the user requested for the same, then it will change all its input to be in 16 bits as well.</li>
<li>If for a given layer output is already a floating point output (e.g. Softmax, DetectionOutputLayer etc) then increasing activation precision has no impact.</li>
</ul>
</li>
</ul>
</li>
<li>Few Points to Note:<ul>
<li>Currently following layers support change in precision and all the other layers cannot have input and output in different precision i.e. their precision is determined by their producer/consumer and both input and output will be in the same precision :<ul>
<li>TIDL_ConvolutionLayer ( Except TIDL_BatchToSpaceLayer and TIDL_SpaceToBatchLayer)</li>
<li>TIDL_BatchNormLayer</li>
<li>TIDL_PoolingLayer ( Excluding Max pooling layer)</li>
<li>TIDL_EltWiseLayer</li>
</ul>
</li>
<li>In future release we will have option to enable automatic selection of each layer's precision.</li>
</ul>
</li>
</ul>
<h3>A.5 Future/Planned Improvements</h3>
<ul>
<li>The following options are not supported in current release but are planned for future TIDL releases:<ul>
<li>Mixed Precision – Automatic selection of layers for mixed precision</li>
<li>Per-channel weight quantization with non-power of 2 quantizationStyle <br />
</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="did_tidl_quantization_2"></a>
B. Guidelines For Training To Get Best Accuracy With Quantization</h2>
<ul>
<li>For best accuracy with post training quantization, we recommend that the training uses sufficient amount of regularization / weight decay. Regularization / weight decay ensures that the weights, biases and other parameters (if any) are small and compact - this is good for quantization. These features are supported in most of the popular training framework.</li>
<li>The weight decay factor should not be too small. We have used a weight decay factor of 1e-4 for training several networks and we highly recommend a similar value. Using small values such as 1e-5 is not recommended.</li>
<li>We also highly recommend to use Batch Normalization immediately after every Convolution layer. This helps the feature map to be properly regularized/normalized. If this is not done, there can be accuracy degradation with quantization. This especially true for Depthwise Convolution layers. However applying Batch Normalization to the very last Convolution layer (for example, the prediction layer in segmentation/object detection network) may hurt accuracy and can be avoided.</li>
<li>To summarize, if you are getting poor accuracy with quantization, please check the following:<ul>
<li>(a) Weight decay is applied to all layers / parameters and that weight decay factor is good.</li>
<li>(b) Ensure that all the Depthwise Convolution layers in the network have Batch Normalization layers after that - there is strictly no exception for this rule. Other Convolution layers in the network should also have Batch Normalization layers after that - however the very last Convolution layer in the network need not have it (for example the prediction layer in a segmentation network or detection network).</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="did_tidl_quantization_3"></a>
C. Quantization Aware Training (QAT)</h2>
<ul>
<li>Model parameters are trained to comprehend the 8-bit fixed point inference loss.</li>
<li>This would need support/change in the training framework</li>
<li>Once a model is trained with QAT, the feature map range values are inserted as part of the model. There is no need to use advanced calibration features for a QAT model. Example – CLIP, Minimum, PACT, RelU6 operators.</li>
<li>This option has resulted in accuracy drop to be very close to zero for most of the networks.</li>
<li>EdgeAI-TorchVision provides tools and examples to do Quantization Aware Training. With the tools provided, you can incorporate Quantization Aware Training in your code base with just a few lines of code change. For detailed documentation and code, please visit <a href="https://github.com/TexasInstruments/edgeai-torchvision/blob/master/docs/pixel2pixel/Quantization.md">Link</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
